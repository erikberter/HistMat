{% extends 'base.html' %}
{% load i18n %}

{% block title %} {% trans 'Foro' %} | HistMat {% endblock %}

{% load static %}

{% block css%}
	<link rel="stylesheet" type="text/css" href="{% static 'css/widgets/fab.css' %}">  

	<script src='https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js'></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/shortcuts/infinite.min.js'></script>

{% endblock %}

{% block js%}
<script type="text/javascript">     window.CSRF_TOKEN = "{{ csrf_token }}"; </script> 
<script>
	var fab = new Vue({
		el: '#fab-container',
		data: {
			create_url: "{% url 'forum:add_post' %}"
		},
		methods: {
			fab_action: function (event) {
				window.location = this.create_url;
			}
		}
	})
</script>

{% if user.is_authenticated %}
<script>
	$(document).ready(function(){

		$(".like-button").click(function(){
			let pk  = $(this).attr('pk');
			$.ajax({
				type: "POST",
				url: "post_detail/" + pk + "/upvote",
				dataType:'json',
				data: {
					csrfmiddlewaretoken: window.CSRF_TOKEN
				},
				success: (json) =>{
					var like_counter = parseInt($(".like-count-" + pk).text());
					$(this).hasClass('far') ? like_counter++ : like_counter--;

					$(".like-count-" + pk).text(like_counter);
					$(this).toggleClass('fas far');
					
				},
				error: function(result) {
					alert('error');
				}
			});
		});
	});
</script>
{% endif %}

   
{% endblock %}

{% block content %} 
<div class="container">
	<div class="mt-3 infinite-container justify-content-md-center align-items-center">
		{% load like_tags %}
		{% for post in posts %}
			<div class="card w-100 d-flex p-3 my-2 infinite-item shadow">
					<p> 
						{% trans 'Enviado por'%} 
						<a href="{{post.user.get_absolute_url}}">{{ post.user }}</a>
						 , {{ post.created }}.
					</p>
					<a href="{{post.get_absolute_url}}">
						<h2>
							<strong>
								{{ post.title }}
							</strong>
						</h2>
					</a>
					<div class="pt-2">
						{% if post.image %}
							<div class="d-flex justify-content-center">
								<a class="w-75" href="{{post.get_absolute_url}}">
									<img class="rounded img-fluid" src="{{post.image.url}}">
								</a>
							</div>
						{% else %}
							<p>
								{{ post.body|truncatechars:400 }}
							</p>
						{% endif %}
					</div>	
					<div>
						{% is_liked post user as post_liked %}
						<i class="{% if post_liked%}fas{%else%}far{% endif%} fa-thumbs-up like-button mt-2 mx-2" pk='{{post.pk}}'></i> 
						<span class="like-count-{{post.pk}} font-weight-bold">{{ post.likes }}</span> 
					</div>
				</div>
		{% empty %}
			<div class="card p-3 rcorners2 my-3 shadow-sm">
				<div class="d-flex justify-content-center">
					<h1>
						<strong>
							{% trans 'El foro esta vacio. Se el primero en escribir algo!' %}
						</strong>
					</h1>
				</div>
			</div>
		{% endfor%}
		</div>
	{% if page_obj.has_next %}
        <a class="infinite-more-link" href="?page={{ page_obj.next_page_number }}"></a>
	{% endif %}
	
	<div class="d-flex justify-content-center" style="display:none;">
        <div id="loading-icon" class="spinner-border" role="status" style="display:none;">
            <span id="spd" class="sr-only">{% trans 'Cargando' %}...</span>
        </div>
    </div>
</div>


<script>
$(document).ready( function() {
	var infinite = new Waypoint.Infinite({
		element: $('.infinite-container')[0],
		onBeforePageLoad: function () {
			$('#loading-icon').show();
		},
		onAfterPageLoad: function ($items) {
			$('#loading-icon').css("display","none");
		}
	});
});
</script>

{% if user.is_authenticated %}
	{% include 'widgets/fab.html'%}
{% endif%}

{% endblock %}